<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <script type="module" src="../framework/dist/index.js"></script>

    <style type="text/css">
        body {
            background: #fff;
            display: flex;
            flex-wrap: wrap;
        }

        core-picture {
            width: 240px;
            height: 180px;
            flex: none;
        }
    </style>
</head>

<body>
    <script type="module">
        import * as Core from "../framework/dist/index.js";

        const Web = Core.Web;
        const Ajax = Web.Ajax.Ajax;
        const AjaxResponseType = Web.Ajax.AjaxResponseType;

        class CoreControl extends HTMLElement {
            constructor() {
                super();

                const shadow = this.attachShadow({ mode: "closed" });
                this.__shadow = shadow;

                const style = document.createElement("style");
                this.__style = style;
                style.innerHTML = "@import url('./controls.css');";
            }

            connectedCallback() {
                this.__shadow.appendChild(this.__style);
            }

            disconnectedCallback() {
                this.__style.remove();
            }
        }

        class CoreProgressBar extends CoreControl {
            constructor() {
                super();

                const fill = document.createElement("core-progress-bar-fill");
                this.__fill = fill;
            }

            __update() {
                if (this.indeterminate) {
                    this.__fill.style.flex = "1";
                    this.__fill.classList.add("core-progress-bar-fill-indeterminate");
                }
                else {
                    const normalizedValue = (this.value - this.min) / (this.max - this.min);
                    this.__fill.style.flex = normalizedValue;
                    this.__fill.classList.remove("core-progress-bar-fill-indeterminate");
                }
            }

            static get observedAttributes() {
                return ["core-min", "core-max", "core-value", "core-indeterminate"];
            }

            get min() { return this.__min; }
            set min(value) {
                this.__min = Math.min(this.value, this.max - Number.EPSILON);
                this.__update();
            }
            __min = 0;

            get max() { return this.__max; }
            set max(value) {
                this.__max = Math.max(value, this.min + Number.EPSILON);
                this.__update();
            }
            __max = 1;

            get value() { return this.__value; }
            set value(value) {
                this.__value = Math.max(Math.min(value, this.max), this.min);
                this.__indeterminate = false;
                this.__update();
            }
            __value = 0;

            get indeterminate() { return this.__indeterminate; }
            set indeterminate(value) {
                this.__indeterminate = value;
                this.__update();
            }
            __indeterminate = true;

            __min_attribute_changed(value) {
                this.min = Number(value);
            }

            __max_attribute_changed(value) {
                this.max = Number(value);
            }

            __value_attribute_changed(value) {
                this.value = Number(value);
            }

            __indeterminate_attribute_changed(value) {
                this.indeterminate = value !== null;
            }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name == "core-min")
                    this.__min_attribute_changed(newValue);
                else if (name == "core-max")
                    this.__max_attribute_changed(newValue);
                else if (name == "core-value")
                    this.__value_attribute_changed(newValue);
                else if (name == "core-indeterminate")
                    this.__indeterminate_attribute_changed(newValue);
            }

            connectedCallback() {
                super.connectedCallback();

                this.__shadow.appendChild(this.__fill);

                this.__update();
            }

            disconnectedCallback() {
                super.disconnectedCallback();

                this.__fill.remove();
            }

            adoptedCallback() {

            }
        }
        customElements.define("core-progress-bar", CoreProgressBar)

        class CoreImage extends CoreControl {
            constructor() {
                super();

                const img = document.createElement("img");
                this.__img = img;

                const progressBar = document.createElement("core-progress-bar");
                this.__progressBar = progressBar;
            }

            connectedCallback() {
                super.connectedCallback();

                this.__shadow.appendChild(this.__img);
                this.__shadow.appendChild(this.__progressBar);
            }

            disconnectedCallback() {
                super.disconnectedCallback();

                this.__img.remove();
            }

            static get observedAttributes() {
                return ["core-src"];
            }

            async __load(src) {
                let self = this;

                function onProgress(sender, args) {
                    self.__progressBar.value = args.loaded;
                    self.__progressBar.max = args.total;
                }

                if (src) {
                    this.__progressBar.indeterminate = true;
                    this.__progressBar.hidden = false;
                    this.__img.hidden = true;

                    let blob = await Ajax.get(src, { onProgress }, { responseType: AjaxResponseType.Blob });
                    this.__img.src = URL.createObjectURL(blob);

                    this.__img.hidden = false;
                    this.__progressBar.hidden = true;
                }
            }

            __update() {
                __load(this.src);
            }

            get src() { return this.__src; }
            set src(value) {
                __update();
                this.__src = value;
            }
            __src = "";

            __src_attribute_changed(value) {
                this.__load(value);
            }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name == "core-src")
                    this.__src_attribute_changed(newValue);
            }

            adoptedCallback() {

            }
        }
        customElements.define("core-picture", CoreImage);
    </script>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>

    <core-picture core-src="./aerial-view-of-seashore-near-large-grey-rocks-853199.jpg">
    </core-picture>
</body>

</html>